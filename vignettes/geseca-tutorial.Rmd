---
title: "geseca-tutorial"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{geseca-tutorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

An R-package for performing GEne SEt Co-regulation Analysis (GESECA).

## Quick run

Loading necessary libraries

```{r message=FALSE}
library(fgsea)
library(data.table)
```

```{r echo=FALSE}
library(BiocParallel)
register(SerialParam())
```

Loading example expression matrix and pathways:

```{r message=FALSE}
data(exampleExpressionMatrix)
str(exampleExpressionMatrix)
```
`exampleExpressionMatrix` - numeric expression matrix of the GSE14308 dataset. Rows correspond to genes (ENTREZID is used as identifiers), columns correspond to samples. **Note:** `geseca` expects that the values of expression matrix are log-scaled and the samples are quantile normalized. To get more information about steps that were performed to process the GSE14308 expression matrix, use: `?exampleExpressionMatrix`.


```{r message=FALSE}
data(examplePathways)
str(head(examplePathways, 3))
```
`examplePathways` - list of mouse pathways from `reactome.db` package. The list of gene sets should use the same identifiers that are used in `rownames(exampleExpressionMatrix)`. To get more information about this list, use: `?examplePathways`

Running `geseca`:
```{r}
gesecaRes <- geseca(examplePathways, exampleExpressionMatrix, minSize = 15, maxSize = 500)
head(gesecaRes[order(pval), ], 5)
```
Optionally, it is possible to scale the values of each gene-row to a unit variance by passing the `scale=TRUE` to `geseca`.


## Analysis of time course data

We will analyze time course data of Th2 activation from the dataset GSE200250.


First, let prepare the dataset.

```{r message=FALSE}
library(GEOquery)
library(limma)

gse200250 <- getGEO("GSE200250", AnnotGPL = TRUE)[[1]]

es <- gse200250
es <- es[, grep("Th2_", es$title)]
es$time <- as.numeric(gsub(" hours", "", es$`time point:ch1`))
es <- es[, order(es$time)]

exprs(es) <- normalizeBetweenArrays(log2(exprs(es)), method="quantile")

es <- es[order(rowMeans(exprs(es)), decreasing=TRUE), ]
es <- es[!duplicated(fData(es)$`Gene ID`), ]
rownames(es) <- fData(es)$`Gene ID`
es <- es[!grepl("///", rownames(es)), ]
es <- es[rownames(es) != "", ]

fData(es) <- fData(es)[, c("ID", "Gene ID", "Gene symbol")]

es <- es[head(order(rowMeans(exprs(es)), decreasing=TRUE), 12000), ]
```

We will consider MSigDB Hallmark pathways.


```{r}
library(msigdbr)
pathwaysDF <- msigdbr("mouse", category="H")
pathways <- split(pathwaysDF$entrez_gene, pathwaysDF$gs_name)
```

Running GESECA analysis.

```{r}
set.seed(1)
gesecaRes <- geseca(pathways, exprs(es), minSize = 15, maxSize = 500)   

head(gesecaRes, 10)
```

We can plot gene expression profile of HALLMARK_E2F_TARGETS pathway and see that 
these gene are strongly activated at 24 hours time point:


```{r fig.width=7, fig.height=4}
plotCoregulationProfile(pathway=pathways[["HALLMARK_E2F_TARGETS"]], 
                        E=exprs(es), titles = es$title, conditions=es$`time point:ch1`)
```

Hypoxia genes have slightly different profile, getting activated around 48 hours:


```{r fig.width=7, fig.height=4}
plotCoregulationProfile(pathway=pathways[["HALLMARK_HYPOXIA"]], 
                        E=exprs(es), titles = es$title, conditions=es$`time point:ch1`)


```

To get an overview of the pathway patterns we can use `plotGesecaTable` function:

```{r fig.width=7, fig.height=6}
plotGesecaTable(gesecaRes |> head(10), pathways, E=exprs(es), titles = es$title)
```
